{% extends "base.html" %}

{% block title %}Companies - JAIBird{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-3">
    <div>
        <h4 class="mb-0"><i class="bi bi-building"></i> Company Intelligence</h4>
        <small class="text-muted"><span id="companyCount">{{ company_count }}</span> companies tracked</small>
    </div>
    <div class="d-flex gap-2 align-items-center">
        <input type="text" class="form-control form-control-sm" id="companySearch"
               placeholder="Search companies..." style="width:250px;">
        <button class="btn btn-sm btn-outline-primary" onclick="loadCompanies()">
            <i class="bi bi-arrow-clockwise"></i>
        </button>
    </div>
</div>

<div class="card">
    <div class="card-body p-0">
        <div class="table-responsive">
            <table class="table table-hover table-sm mb-0" id="companiesTable">
                <thead class="table-light">
                    <tr>
                        <th style="cursor:pointer;" onclick="sortTable('jse_code')">Code <i class="bi bi-chevron-expand small"></i></th>
                        <th style="cursor:pointer;" onclick="sortTable('name')">Company <i class="bi bi-chevron-expand small"></i></th>
                        <th style="cursor:pointer;" onclick="sortTable('sector')">Sector</th>
                        <th>Sponsor</th>
                        <th class="text-center" style="cursor:pointer;" onclick="sortTable('director_count')">Directors</th>
                        <th class="text-center" style="cursor:pointer;" onclick="sortTable('sens_count')">SENS</th>
                        <th>Description</th>
                    </tr>
                </thead>
                <tbody id="companiesBody">
                    <tr><td colspan="7" class="text-center text-muted py-4">
                        <div class="spinner-border spinner-border-sm"></div> Loading...
                    </td></tr>
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Company Detail Modal -->
<div class="modal fade" id="companyModal" tabindex="-1">
    <div class="modal-dialog modal-xl modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="companyModalTitle">Company Detail</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="companyModalBody">
                <div class="text-center py-4"><div class="spinner-border"></div></div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let allCompanies = [];
let sortCol = 'name';
let sortAsc = true;
let searchTimer = null;

document.addEventListener('DOMContentLoaded', () => {
    loadCompanies();
    document.getElementById('companySearch').addEventListener('input', () => {
        clearTimeout(searchTimer);
        searchTimer = setTimeout(loadCompanies, 300);
    });
});

async function loadCompanies() {
    try {
        const q = document.getElementById('companySearch').value.trim();
        const url = q ? `/api/companies?q=${encodeURIComponent(q)}` : '/api/companies';
        const resp = await fetch(url);
        const json = await resp.json();
        if (json.status !== 'success') return;
        allCompanies = json.data;
        document.getElementById('companyCount').textContent = json.count;
        renderTable();
    } catch (e) { console.error('Failed to load companies:', e); }
}

function sortTable(col) {
    if (sortCol === col) { sortAsc = !sortAsc; }
    else { sortCol = col; sortAsc = true; }
    renderTable();
}

function renderTable() {
    const tbody = document.getElementById('companiesBody');
    if (!allCompanies.length) {
        tbody.innerHTML = '<tr><td colspan="7" class="text-center text-muted py-4">No companies found</td></tr>';
        return;
    }

    const sorted = [...allCompanies].sort((a, b) => {
        let va = a[sortCol] ?? '', vb = b[sortCol] ?? '';
        if (typeof va === 'string') va = va.toLowerCase();
        if (typeof vb === 'string') vb = vb.toLowerCase();
        if (va < vb) return sortAsc ? -1 : 1;
        if (va > vb) return sortAsc ? 1 : -1;
        return 0;
    });

    tbody.innerHTML = sorted.map(c => {
        const code = esc(c.jse_code || '—');
        const name = esc(c.name || '');
        const sector = esc(c.sector || '');
        const sponsor = esc(c.sponsor || '');
        const desc = esc(trunc(c.description || '', 60));
        const dirs = c.director_count || 0;
        const sens = c.sens_count || 0;
        return `<tr style="cursor:pointer;" onclick="showDetail(${c.id})">
            <td><strong>${code}</strong></td>
            <td>${name}</td>
            <td><small class="text-muted">${sector}</small></td>
            <td><small>${sponsor}</small></td>
            <td class="text-center">${dirs > 0 ? '<span class="badge bg-info">' + dirs + '</span>' : '<span class="text-muted">—</span>'}</td>
            <td class="text-center">${sens > 0 ? '<span class="badge bg-secondary">' + sens + '</span>' : '<span class="text-muted">—</span>'}</td>
            <td><small class="text-muted">${desc}</small></td>
        </tr>`;
    }).join('');
}

async function showDetail(companyId) {
    const modal = new bootstrap.Modal(document.getElementById('companyModal'));
    document.getElementById('companyModalTitle').textContent = 'Loading...';
    document.getElementById('companyModalBody').innerHTML =
        '<div class="text-center py-4"><div class="spinner-border"></div></div>';
    modal.show();

    try {
        const resp = await fetch(`/api/companies/${companyId}`);
        const json = await resp.json();
        if (json.status !== 'success') {
            document.getElementById('companyModalBody').innerHTML =
                '<div class="alert alert-danger">Failed to load company data</div>';
            return;
        }
        const c = json.data;
        document.getElementById('companyModalTitle').innerHTML =
            `<strong>${esc(c.jse_code || '')}</strong> &mdash; ${esc(c.name)}`;

        let html = '';

        // Description
        if (c.description) {
            html += `<div class="mb-3">
                <h6><i class="bi bi-info-circle"></i> About</h6>
                <p class="mb-0">${esc(c.description)}</p>
            </div>`;
        }

        // KPI row
        html += `<div class="row g-2 mb-3">
            <div class="col-4 col-md-2">
                <div class="border rounded text-center py-2">
                    <div class="fw-bold">${esc(c.jse_code || '—')}</div>
                    <div class="text-muted" style="font-size:0.7rem;">JSE Code</div>
                </div>
            </div>
            <div class="col-4 col-md-2">
                <div class="border rounded text-center py-2">
                    <div class="fw-bold">${esc(c.sector || '—')}</div>
                    <div class="text-muted" style="font-size:0.7rem;">Sector</div>
                </div>
            </div>
            <div class="col-4 col-md-3">
                <div class="border rounded text-center py-2">
                    <div class="fw-bold">${esc(c.sponsor || '—')}</div>
                    <div class="text-muted" style="font-size:0.7rem;">JSE Sponsor</div>
                </div>
            </div>
            <div class="col-6 col-md-2">
                <div class="border rounded text-center py-2">
                    <div class="fw-bold">${esc(c.website || '—')}</div>
                    <div class="text-muted" style="font-size:0.7rem;">Website</div>
                </div>
            </div>
            <div class="col-6 col-md-3">
                <div class="border rounded text-center py-2">
                    <div class="fw-bold">${c.last_updated ? new Date(c.last_updated).toLocaleDateString('en-ZA') : '—'}</div>
                    <div class="text-muted" style="font-size:0.7rem;">Last Updated</div>
                </div>
            </div>
        </div>`;

        // Directors
        const directors = c.directors || [];
        const activeDirs = directors.filter(d => d.is_active);
        const resignedDirs = directors.filter(d => !d.is_active);

        html += `<div class="mb-3">
            <h6><i class="bi bi-people"></i> Directors (${activeDirs.length} active)</h6>`;

        if (activeDirs.length) {
            html += `<table class="table table-sm table-bordered">
                <thead class="table-light"><tr><th>Name</th><th>Role</th><th>Appointed</th><th>Source</th></tr></thead>
                <tbody>` +
                activeDirs.map(d => `<tr>
                    <td>${esc(d.name)}</td>
                    <td><small>${esc(d.role || '—')}</small></td>
                    <td><small class="text-muted">${d.appointed_date ? new Date(d.appointed_date).toLocaleDateString('en-ZA') : '—'}</small></td>
                    <td><small class="text-muted">${esc(d.source_sens || '')}</small></td>
                </tr>`).join('') +
                `</tbody></table>`;
        } else {
            html += '<p class="text-muted small">No director information yet</p>';
        }

        if (resignedDirs.length) {
            html += `<details class="mb-2"><summary class="small text-muted">${resignedDirs.length} resigned director(s)</summary>
                <table class="table table-sm table-bordered mt-1">
                <thead class="table-light"><tr><th>Name</th><th>Role</th><th>Resigned</th></tr></thead>
                <tbody>` +
                resignedDirs.map(d => `<tr class="text-muted">
                    <td>${esc(d.name)}</td>
                    <td><small>${esc(d.role || '')}</small></td>
                    <td><small>${d.resigned_date ? new Date(d.resigned_date).toLocaleDateString('en-ZA') : '—'}</small></td>
                </tr>`).join('') +
                `</tbody></table></details>`;
        }
        html += '</div>';

        // Sponsor history
        const sponsors = c.sponsor_history || [];
        if (sponsors.length > 1) {
            html += `<div class="mb-3">
                <h6><i class="bi bi-clock-history"></i> Sponsor History</h6>
                <ul class="list-group list-group-flush small">` +
                sponsors.map(s => `<li class="list-group-item py-1">
                    <strong>${esc(s.sponsor)}</strong>
                    <span class="text-muted ms-2">${s.effective_date ? new Date(s.effective_date).toLocaleDateString('en-ZA') : ''}</span>
                    <span class="text-muted ms-1">${s.source ? '(' + esc(s.source) + ')' : ''}</span>
                </li>`).join('') +
                `</ul></div>`;
        }

        // Recent SENS
        const sens = c.recent_sens || [];
        if (sens.length) {
            html += `<div class="mb-3">
                <h6><i class="bi bi-file-earmark-text"></i> Recent SENS (${sens.length})</h6>
                <div class="list-group list-group-flush small" style="max-height:300px;overflow-y:auto;">` +
                sens.map(s => `<div class="list-group-item py-1">
                    <div class="d-flex justify-content-between">
                        <span>${esc(s.title)}</span>
                        <small class="text-muted text-nowrap ms-2">${s.date_published ? new Date(s.date_published).toLocaleDateString('en-ZA') : ''}</small>
                    </div>
                    <small class="text-muted">${esc(s.sens_number)}</small>
                </div>`).join('') +
                `</div></div>`;
        }

        // Link to prices page
        if (c.jse_code) {
            html += `<div class="mt-3">
                <a href="/prices" class="btn btn-sm btn-outline-primary">
                    <i class="bi bi-currency-exchange"></i> View ${esc(c.jse_code)} Prices
                </a>
            </div>`;
        }

        document.getElementById('companyModalBody').innerHTML = html;
    } catch (e) {
        document.getElementById('companyModalBody').innerHTML =
            '<div class="alert alert-danger">Error loading company details</div>';
    }
}

function trunc(t, n) { return !t ? '' : (t.length > n ? t.substring(0, n-1) + '\u2026' : t); }
function esc(t) { if (!t) return ''; const d = document.createElement('div'); d.textContent = String(t); return d.innerHTML; }
</script>
{% endblock %}
